---
title: "US Inflation Analysis"
subtitle: "Capstone Project: Duke University Data Science with R"
author: "Roberto_Antuna"
date: "2026-01-26"
format:
  html:
    toc: true
    toc-location: left
    code-fold: true
    echo: true
    theme: cosmo
---

## Introduction

An exploratory data analysis (EDA) was conducted to analyze a dataset with historical inflation data (from 2011 to 2021) from 12 CPI divisions. A second dataset was used to obtain the description of the divisions, through a join using the key variable.

The Organisation for Economic Co-operation and Development defines inflation as follows:

> Inflation is a rise in the general level of prices of goods and services that households acquire for the purpose of consumption in an economy over a period of time.
>
> The main measure of inflation is the annual inflation rate which is the movement of the Consumer Price Index (CPI) from one month/period to the same month/period of the previous year expressed as percentage over time.
>
> Source: [OECD CPI FAQ](https://www.oecd.org/sdd/prices-ppp/consumerpriceindices-frequentlyaskedquestionsfaqs.htm#1)

CPI is broken down into 12 divisions such as food, housing, health, etc.

### Business Objectives

This analysis seeks to provide a historical perspective for public policy analysts, using the data to produce the following:

1.  Calculate the minimum and maximum annual inflation percentage for each CPI Division.
2.  Create a plot of annual inflation vs. year for Divisions 1, 3, 7, and 10.
3.  Which CPI divisions most frequently experienced deflationary periods between 2011 and 2021, and how does this impact long-term price stability?

**Bonus Chapter:** *Clustering*

![](images/inflation.png){fig-alt="Cash" fig-align="center" width="300" height="\"180"}

## Packages

```{r}
#| label: packages
#| warning: false
#| message: false
library(tidyverse)
library(tidymodels)
library(readxl)
library(scales)
library(ggrepel)
library(skimr)
```

## Data

The data needed to explore US inflation are spread across two files:

-   **us-inflation.csv**: Annual inflation rate for the US for 12 CPI divisions. Each division is identified by an ID number.
-   **cpi-divisions.xlsx**: A "lookup table" of CPI division ID numbers and their descriptions.

The following steps import and provide an initial overview of the datasets:

*us-inflation*

```{r}
#| label: reading-csv-file
#read csv file
us_inflation <- read_csv(file = "data/us-inflation.csv", show_col_types = FALSE)
#glimpse csv file
glimpse(us_inflation)
```

*cpi-divisions*

```{r}
#| label: reading-excel-file
#| warning: false
#| message: false
#read excel file
cpi_divisions <- read_excel(path = "data/cpi-divisions.xlsx", .name_repair = "unique_quiet")
#glimpse excel file
glimpse(cpi_divisions)
```

During the initial inspection, it was identified that the Excel file contained metadata in the first row, so it was skipped to ensure a clean load.

```{r}
#| label: fixing-excel-file
#read excel file
cpi_divisions <- read_excel(path = "data/cpi-divisions.xlsx", skip = 1)
#glimpse excel file
glimpse(cpi_divisions)
```

### Data Dictionary

A data table for each dataset can be seen below:

*us-inflation*

| Variable | Description |
|:-----------------------------------|:-----------------------------------|
| `country` | location data; all values "United States". |
| `cpi_division_id` | numerical value to represent cpi division. |
| `2011` | annual inflation percentage for the year 2011 by cpi division. |
| `2012` | annual inflation percentage for the year 2012 by cpi division. |
| `...` | ... |
| `2021` | annual inflation percentage for the year 2021 by cpi division. |

\
*cpi-divisions*

| Variable      | Description                                |
|:--------------|:-------------------------------------------|
| `id`          | numerical value to represent cpi division. |
| `description` | description of the cpi value.              |

## General Data Overview

As noted during the initial inspection, the *us_inflation* dataset is in a wide format. To facilitate the analysis, it will be transformed into a long format using **tidyr::pivot_longer()**.

```{r}
#| label: pivot-us-inflation
#pivoting data
us_inflation_long <- us_inflation |> 
  pivot_longer(
    cols = !c(country, cpi_division_id),
    names_to = "year",
    values_to = "inflation",
    names_transform = list(year = as.double)
  )
```

Now we can pass the division description to this longer table, using the data in *cpi-divisions*.

```{r}
#| label: create-final-table
#joining data
inflation_joined <- us_inflation_long |> 
  left_join(cpi_divisions, join_by(cpi_division_id == id))
inflation_joined
```

Before diving into specific questions, let’s transform the data types of some variables and then examine the structure and integrity of the final dataset.

```{r}
#| label: data-summary
#transform data types
inflation_joined <- inflation_joined |> 
  mutate(
    description = fct_reorder(description, cpi_division_id),
    cpi_division_id = as.factor(cpi_division_id),
  )
#complete summary of statistics and null values
skim(inflation_joined)
```

\
The final merged dataset consists of **132 observations** across **5 variables**, covering 12 CPI divisions over an 11-year period (2011-2021). A preliminary inspection via the skim() function confirms the following:

-   **Data Integrity:** There are no missing values (n_missing = 0) across all columns, ensuring a successful join between inflation rates and division descriptions.

-   **Distribution:** The average annual inflation rate stands at 1.65%, with a standard deviation of 2.62. This spread suggests significant volatility among different sectors.

-   **Extreme Values:** The presence of long "tails" validates the existence of outliers, ranging from a minimum deflation of -10.02% to a maximum peak of 15.8%.

```{r}
#| label: histogram
#| fig-cap: "Figure 1. Histogram of Inflation Rate Dispersion (2011-2021)."
global_rate <- mean(inflation_joined$inflation)
inflation_joined |>
  mutate(inflation = inflation/100) |> 
  ggplot(aes(x = inflation)) + 
  geom_histogram(binwidth = 0.01, fill = "gray60", alpha = 0.8) + 
  geom_vline(xintercept = global_rate/100, linetype = "dashed", color = "gray40") + 
  annotate(
    "text", 
    x = 0, 
    y = 33,
    label = paste("Avg:", percent(global_rate/100, 0.01)),
    color = "gray30", 
    size = 3.1,
    fontface = "bold"
  ) +
  scale_x_continuous(
    labels = scales::percent,
    breaks = seq(-0.15, 0.2, 0.05)
  ) +
  labs(
    title = "Distribution of Annual Inflation Rates",
    subtitle = "Most sectors near the 1.65% average, while extreme values indicate high-volatility events",
    x = "Inflation Percentage",
    y = "Frequency"
  )+
  theme_minimal() +
  theme(panel.grid.minor = element_blank()) 
```

## Task 1

Calculate the minimum and maximum annual inflation percentage for each CPI Division.

```{r}
#| label: tabble-summary
#Complete summary of statistics and null values
inflation_joined |> 
  group_by(description) |> 
  summarise(
    min_inflation = min(inflation),
    year_min = year[which.min(inflation)],
    max_inflation = max(inflation),
    year_max = year[which.max(inflation)]
  ) |> 
  mutate(
    min_inflation = paste0(round(min_inflation,2),"%"),
    max_inflation = paste0(round(max_inflation,2),"%")
  ) |> 
  knitr::kable(
    col.names = c("CPI Division", "Min Inflation", "Year (Min)", 
                  "Max Inflation", "Year (max)"),
    align = "lcccc",
    caption = "Table 1. Min and Max Annual Inflations by CPI Division"
  )
```

**Analysis:**

The summary of annual inflation percentages by CPI division reveals a diverse economic landscape across the 11-year period:

-   **High Volatility:** The *Transport* sector stands out as the most volatile, recording both the lowest minimum (-10.02% in 2015) and the highest maximum (15.8% in 2021). While the dataset does not specify external causes, this behavior is typical of sectors highly dependent on global commodity prices.

-   **Deflationary Trends:** Several divisions experienced periods of deflation (negative inflation), most notably *Communication* at -5.48% and *Clothing and footwear* at -4.45%.

-   **Relative Stability:** In contrast, sectors like *Education* and *Health* maintained positive inflation rates throughout the entire decade, with minimums above 1.1% and relatively narrow ranges compared to other categories.

-   **Synchronized 2021 Peaks:** A key finding is the inflationary surge toward the end of the study period. Nearly half of the categories (5 out of 12) reached their maximum historical inflation in 2021.

## Task 2

Create a plot of annual inflation vs. year for divisions 1, 3, 7, and 10.

```{r}
#| label: rates-evolution
#| fig-cap: "Figure 2. Comparative Evolution of Annual Inflation Ratesb (2011-2021). The dashed reference line at 0%."
#filtering divisions
inflation_joined |> 
  filter(cpi_division_id %in% c(1,3,7,10)) |> 
  mutate(inflation = inflation/100)|> 
  ggplot(aes(x = year, y = inflation, 
             color = description, 
             group = description)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  geom_hline(yintercept = 0, color = "black", 
             linewidth = 0.5, linetype = "dashed", 
             alpha = 0.5) +
  scale_color_viridis_d(option = "plasma") +
  scale_linetype_manual(values = c("solid", "dashed", "dotted", "dotdash")) +
  scale_y_continuous(
    labels = scales::percent,
    breaks = seq(-0.1, 0.1, 0.1)
  ) +
  scale_x_continuous(breaks = seq(2011, 2021, 2)) +
  labs(
    title = "Macroeconomic Trends across selected Sectors",
    subtitle = "Education maintains a steady decline, Transport exhibits severe fluctuations",
    x = "Year",
    y = "Annual Inflation Rate",
    color = "CPI Division",
    linetype = "CPI Division"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.box = "vertical",
    legend.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank()
  ) +
  guides(
    color = guide_legend(
      title.position = "top",
      title.hjust = 0.5
    ),
    linetype = guide_legend(
      title.position = "top", 
      title.hjust = 0.5
    )
  )
```

**Analysis:**

The visual analysis of selected CPI divisions (1, 3, 7, and 10) illustrates how different sectors respond to economic cycles:

-   **The 2015 Energy Shock:** The most prominent feature of the plot is the sharp decline in the *Transport* division (Division 7), which hit a historical low of **-10.02%** in 2015. This dramatic drop visually confirms the sector's extreme sensitivity to external shocks, likely tied to global energy price collapses during that year.

-   **Sector Divergence:** While *Transport* shows high volatility, the other selected divisions—such as *Food and non-alcoholic beverages* (Division 1) and *Clothing and footwear* (Division 3)—exhibit much smoother trajectories with less drastic annual swings.

-   **Convergent Recovery:** Toward the end of the period, there is a clear upward trend across multiple lines. The *Transport* sector, in particular, shows a steep recovery from its **2020 pandemic low** (-4.45%) to its **peak in** **2021**.

-   **Consistent Mid-Period Stability:** Between 2016 and 2019, most selected divisions showed a period of relative stabilization, with inflation rates hovering closer to the overall mean of **1.65%** before the disruptions of the final two years.

## Task 3

Which CPI divisions most frequently experienced deflationary periods between 2011 and 2021, and how does this impact long-term price stability?

```{r}
#| label: deflation-freq-1
#| fig-cap: "Figure 3. Frequency of Deflationary Events by CPI Division (2011-2021). The counts represent the total years each sector recorded negative annual inflation."
# 1- Bar chart
inflation_joined |> 
  filter(inflation < 0) |> 
  group_by(description) |> 
  summarize(n = n()) |> 
  ggplot(aes(x = fct_reorder(description, -n), y = n)) +
  geom_col(aes(alpha = n), fill = "steelblue", show.legend = FALSE) +
  geom_text(aes(label = n), vjust = -0.5, fontface = "bold", color = "gray30") +
  scale_alpha_continuous(range = c(0.4, 1)) +
  scale_x_discrete(labels = scales::label_wrap(18)) +
  scale_y_continuous(labels = NULL, limits = c(0, 8)) +
  labs(
    title = "Deflationary Recurrence by Sector",
    subtitle = "Communication and Transport lead as the divisions most prone to annual price drops",
    x = NULL,
    y = NULL
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(size = 9)
  )
```

```{r}
#| label: deflation-freq-2
# 2- summary table
inflation_joined |> 
  filter(inflation < 0) |> 
  group_by(description) |> 
  summarise(
    years = paste(sort(year), collapse = ", "),
    count = n()
  ) |> 
  arrange(desc(count)) |> 
  select(-count) |>
  knitr::kable(
    col.names = c("CPI Division", "Years with Negative Inflation"),
    caption = "Table 2. Detailed Years of Deflationary Periods"
  )
```

**Analysis:**

The analysis of deflation frequency provides critical insights into which sectors are most prone to price contractions, a key indicator for economic stimulus planning:

-   **High Deflation Frequency:** The **Communication** sector is the most frequent outlier, experiencing deflation in **7 out of 11 years**. This persistent trend may be driven by rapid technological advancements and intense market competition, suggesting it is a sector where consumers consistently gain purchasing power.

-   **Recurrent Volatility:** Both **Transport** and **Furnishings & Household Maintenance** recorded **6 years of deflation**. For public policy, this highlights these sectors as primary candidates for "economic safety nets," as they are highly susceptible to global supply chain disruptions and shifts in consumer demand.

-   **Resilient Categories:** In contrast, sectors like **Food and non-alcoholic beverages** and **Recreation and culture** experienced only **2 years of deflation**, indicating they are more resistant to price drops and generally follow a more stable inflationary path.

This "Deflationary Map" allows analysts to prioritize sectors that might require intervention during economic downturns, identifying **Communication** and **Transport** as the most structurally sensitive areas within the CPI.

## Bonus Chapter

### 1. Defining Economic Fingerprints (Feature Engineering)

By summarizing 11 years of data into three key dimensions—**Trend** (Average Inflation), **Uncertainty** (Volatility), and **Vulnerability** (Deflation Frequency)—we define a unique "economic fingerprint" for each sector.

While individual trends provide historical context, they do not explicitly show how different sectors cluster together based on systemic risk. In this bonus chapter, we use Machine Learning (K-means Clustering) to group CPI divisions into Risk Profiles. This allows policymakers to move from analyzing 12 separate lines to managing 3 or 4 strategic economic groups.

```{r}
#| label: features-matrix
#| message: false
# Feature Engineering: Summarizing 11 years into 3 behavioral metrics
cpi_features <- inflation_joined |> 
  group_by(description) |> 
  summarise(
    avg_inf = mean(inflation),
    volatility = sd(inflation),
    deflation_count = sum(inflation < 0)
  )
# Displaying the matrix for analysis  
cpi_features |> 
  knitr::kable(
    col.names = c("CPI Division", "Avg Inflation",
                  "Volatility (sd)", "Deflation Frequency"),
    align = "lccc",
    digits = 2,
    caption = "Table 3. Feature Matrix"
  )
```

### 2. Leveling the Playing Field (Data Scaling)

Machine Learning algorithms are sensitive to scale. Without normalization, the model would over-prioritize **Deflation Frequency** (ranging from 0 to 7) over **Average Inflation** (often \< 1%). Scaling ensures each metric contributes equally to the final risk profile by centering the mean at 0 and setting the standard deviation to 1.

```{r}
#| label: normalization-recipe
#| message: false
# 1. Defining the Recipe
cpi_recipe <- recipe(~ ., data = cpi_features) |> 
  update_role(description, new_role = "id") |> 
  step_normalize(all_predictors()) |>
  step_zv(all_predictors())

# 2. Preparing and Applying the Transformation (Prep & Bake)
cpi_prep <- prep(cpi_recipe)
cpi_norm <- bake(cpi_prep, new_data = NULL)

# Displaying the normalized data
cpi_norm |> knitr::kable(
    col.names = c("CPI Division", "Avg Inflation",
                  "Volatility", "Deflation"),
    align = "lccc",
    digits = 2,
    caption = "Table 4. Normalized Feature Matrix"
  )
```

### 3. Finding the Optimal Number of Clusters

We use the **Total Within-Cluster Sum of Squares (WSS)** to identify the "elbow"—the point where adding more clusters no longer significantly reduces the variance within each group. For a policy analyst, this step is crucial to ensure the resulting categories are distinct enough to be actionable without over-complicating the strategic framework.

```{r}
#| label: elbow-method
#| fig-cap: "Figure 4. Elbow Method analysis to determine optimal cluster size. The Total Within-Cluster Sum of Squares (WSS) measures group compactness, identifying the inflection point where additional clusters provide diminishing returns in variance reduction."
set.seed(123)
# Testing k from 1 to 6 to find the point of diminishing returns
wss <- map_dbl(1:6, function(k) {
  kmeans(cpi_norm |> select(-description), centers = k, nstart = 20)$tot.withinss
})
# Plotting the results to visualize the "elbow"
tibble(k = 1:6, wss = wss) |> 
  ggplot(aes(x = k, y = wss)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(size = 3) +
  labs(
    title = "Elbow Method for Optimal K",
    x = "Selecting k = 3 as the ideal balance between model complexity and group distinctness",
    y = "Total Within-Cluster Sum of Squares (WSS)"
  ) +
  theme_minimal()+
  theme(panel.grid.minor = element_blank())
```

### 4. Running the K-means Model (k = 3)

Based on the Elbow Method analysis, we select **k = 3** as the optimal number of clusters. This configuration allows for a clear segmentation of the economy into three distinct risk profiles: Stable, Volatile, and Deflationary-prone sectors, providing a manageable framework for policy intervention.

```{r}
#| label: final-clusters
set.seed(123)
# Executing k-means with the optimal 3 centers
final_kmeans <- kmeans(cpi_norm |> select(-description), centers = 3, nstart = 20)
# Compiling the model results with the original feature data
cpi_results <- cpi_features |> 
  mutate(cluster = as.factor(final_kmeans$cluster))
# Visualizing the preliminary cluster assignment for each sector
cpi_results |> 
  select(description, cluster) |> 
  arrange(cluster) |> 
  knitr::kable(
    col.names = c("CPI Division", "Cluster"),
    align = "lc",
    caption = "Table 5. Sector Cluster Assignment"
  )
```

**Cluster 1: The Economic Anchors.** Comprising essential services like **Health** and **Education**, this group is characterized by high stability and zero deflation frequency. While some sectors, like **Education**, show a downward trend in inflation (disinflation), they remain predictable pillars of the index.

**Cluster 2: The High-Volatility Outlier.** **Transport** stands alone due to its extreme volatility (7.24), which is significantly higher than any other division. This sector represents the primary source of systemic uncertainty for the CPI.

**Cluster 3: Structural Deflation Risk.** This group includes **Communication** and **Clothing**, sectors that frequently experience price drops but with moderate volatility. They represent competitive or technology-driven markets where deflation is a recurring feature rather than a crisis symptom.

### 5. Visualizing the Policy Risk Matrix

This final visualization summarizes the behavioral segmentation of the economy. By plotting **Volatility** against **Average Inflation**, we can clearly distinguish between stable pillars, technological deflationary sectors, and high-risk volatile categories. The size of each point reflects its **Deflation Frequency**, adding a third dimension of vulnerability to the analysis.

```{r}
#| label: cluster-visualization
#| fig-cap: "Figure 5. Macroeconomic Risk Matrix. This multi-dimensional analysis segments CPI divisions based on average inflation, volatility, and deflation frequency (bubble size), providing a comprehensive risk landscape for the 2011-2021 period."
#| fig-width: 9
#| fig-height: 7
ggplot(cpi_results, aes(x = avg_inf, y = volatility, color = cluster)) +
  geom_point(aes(size = deflation_count), alpha = 0.8) +
  geom_text_repel(
    aes(label = description),
    size = 3,
    force = 2,            
    max.overlaps = 20,    
    box.padding = 0.5,    
    show.legend = FALSE   
  ) +
  scale_color_manual(
    values = c("1" = "#0072B2", "2" = "#D55E00", "3" = "#009E73"), 
    name = "Risk Profile",
    labels = c("1: Stable Anchors", "2: Volatile Outliers", "3: Deflationary-prone")
  ) +
  scale_y_continuous(limits = c(0, 8)) +
  labs(
    title = "Policy-Driven Risk Segmentation",
    subtitle = "Strategic grouping identifies Transport as a systemic outlier and isolates structural deflation in competitive sectors",
    x = "Average Annual Inflation (%)",
    y = "Volatility (Standard Deviation)",
    size = "Deflation Years"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank()
  )
```

The model successfully identifies *Transport* (***Cluster 2***) as a systemic anomaly due to its extreme volatility (7.24), despite sharing a similar deflation frequency with more stable groups. **Cluster 1** represents the "Economic Anchors" like *Education* and *Health*, which provide stability with zero deflation years, while **Cluster 3** captures sectors like *Communication* and *Clothing* that experience structural price drops within a manageable volatility range.

## Executive Summary

This analysis provides a comprehensive historical perspective on the Consumer Price Index (CPI) divisions from 2011 to 2021, transforming raw economic data into a strategic framework for policy analysis.

### Key Findings

-   **Systemic Outlier Identification:** While most sectors follow predictable paths, **Transport** was identified as the primary source of economic instability, exhibiting an extreme volatility of **7.24**, nearly four times higher than the average of other divisions.

-   **Structural Deflation Trends:** We discovered that deflation is a recurring feature in specific sectors rather than an economic anomaly. **Communication** and **Furnishings** experienced price drops in over **50%** of the studied years, suggesting technology-driven or competitive market efficiencies.

-   **Macroeconomic Stability Anchors:** Essential services, specifically **Education** and **Health**, were validated as the "Anchors of the Economy." These sectors maintained **zero deflation years** and high predictability, even during periods of broader market fluctuations.

-   **Behavioral Risk Profiles:** Using K-means clustering, the economy was successfully segmented into three actionable risk profiles: **Stable Anchors**, **Volatile Outliers**, and **Deflationary-prone** sectors. This allows for targeted policy interventions instead of "one-size-fits-all" economic strategies.
